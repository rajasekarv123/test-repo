{"jsonrpc":"2.0","id":0,"result":{"qScript":"///$tab Main\r\n//Binary lib://QLIK/shoecare.qvf;\r\n\r\nSET ThousandSep=',';\r\nSET DecimalSep='.';\r\nSET MoneyThousandSep=',';\r\nSET MoneyDecimalSep='.';\r\nSET MoneyFormat='£#,##0.00;-£#,##0.00';\r\nSET TimeFormat='hh:mm:ss';\r\nSET DateFormat='DD MMM YYYY';\r\nSET TimestampFormat='DD/MM/YYYY hh:mm:ss[.fff]';\r\nSET FirstWeekDay=0;\r\nSET BrokenWeeks=1;\r\nSET ReferenceDay=0;\r\nSET FirstMonthOfYear=1;\r\nSET CollationLocale='en-GB';\r\nSET MonthNames='Jan;Feb;Mar;Apr;May;Jun;Jul;Aug;Sep;Oct;Nov;Dec';\r\nSET LongMonthNames='January;February;March;April;May;June;July;August;September;October;November;December';\r\nSET DayNames='Mon;Tue;Wed;Thu;Fri;Sat;Sun';\r\nSET LongDayNames='Monday;Tuesday;Wednesday;Thursday;Friday;Saturday;Sunday';\r\n///$tab Load from QVDs\r\nLOAD\r\n    SessionNumber,\r\n    BasketPurchased,\r\n    ProductDisplayName,\r\n    ProductQuantity,\r\n    ProductBaseValuePerItem,\r\n    ProductValuePerItem,\r\n    ProductCurrencyCode\r\nFROM [lib://DigitalConsumerAnalytics/Basket.qvd]\r\n(qvd);\r\n\r\nLOAD\r\n    SessionNumber,\r\n    BasketProductsViewed,\r\n    BasketProductsAdded,\r\n    AbandonedSession,\r\n    PurchasedSession,\r\n    AbandonandPurchaseSession,\r\n    BasketProductsFailedAdd,\r\n    BasketProductsRemoved,\r\n    BasketProductsPurchased,\r\n    BasketAbandonedValue,\r\n    BasketPurchasedValue,\r\n    SessionMetricValue,\r\n    SessionExitPage,\r\n    SessionCookiesEnabled,\r\n    SessionShortSession,\r\n    SessionSinglePage,\r\n    SessionScriptError,\r\n    SessionMultiPage,\r\n    SessionDuration,\r\n    SessionOffsiteTime,\r\n    SessionIdleTime,\r\n    SessionPages,\r\n    SystemLanguage,\r\n    SystemConnection,\r\n    SessionPopupStatus,\r\n    SessionOptOutStatus,\r\n    UserDataVolume,\r\n    UserDuration,\r\n    NetworkDataVolume,\r\n    NetworkDuration,\r\n    SessionFirstInteraction,\r\n    Attributions\r\nFROM [lib://DigitalConsumerAnalytics/Outcomes.qvd]\r\n(qvd);\r\n\r\nLOAD\r\n    CountryCode,\r\n    SessionNumber,\r\n    DemographicLocation,\r\n    DemographicCityName,\r\n    LandingSearchTerm,\r\n    LandingSearchEngine,\r\n    Num(Date(AddYears(StartTimeDate, 3), 'DD MMM YYYY'))&Mid(SessionStartTimestamp, Index(SessionStartTimestamp, '.')) as SessionStartTimestamp,\r\n    Date(AddYears(StartTimeDate, 3), 'DD MMM YYYY') as StartTimeDate,\r\n//     Date(AddYears(StartTimeDate, 3), 'MMM YYYY') as StartTimeMonthYear,\r\n \r\n    Date#(Month(AddYears(StartTimeDate, 3))&' '&Year(AddYears(StartTimeDate, 3)), 'MMM YYYY') as StartTimeMonthYear,\r\n    \r\n    Date(AddYears(StartTimeDate, 3), 'YYYY') as StartTimeYear,\t\t\t\r\n    WeekDay(Date(AddYears(StartTimeDate, 3))) as StartDayName,\r\n    StartHour,\r\n    StartDay,\r\n    LandingReferrer,\r\n    DeviceType,\r\n    LandingCampaign,\r\n    LandingPlacement,\r\n    LandingCreative,\r\n    LandingCampaignType,\r\n    CookieUniqueVisitorTrackingId,\r\n    CookieFrequency,\r\n    NewCustomer,\r\n    VisitorUiid,\r\n    %UserKey,\r\n//     VisitorLastUpdateTimestamp,\r\n    VisitorUserType,\r\n    VisitorIdentifications,\r\n    Country\r\nFROM [lib://DigitalConsumerAnalytics/StartSession.qvd]\r\n(qvd);\r\n\r\nLOAD\r\n    %UserKey,\r\n    email,\r\n    gender,\r\n    firstName,\r\n    lastName,\r\n    phoneNumber,\r\n    UserCounter\r\nFROM [lib://DigitalConsumerAnalytics/UserData.qvd]\r\n(qvd);\r\n\r\nExit Script;\r\n///$tab QVD LOAD\r\nLOAD\r\n    SessionNumber,\r\n    //DemographicOrganisation,\r\n    //DemographicIsp,\r\n    //DemographicLatitude,\r\n    //DemographicLongitude,\r\n\r\ngeomakepoint(DemographicLatitude, DemographicLongitude) as DemographicLocation,\r\n\r\n    DemographicCityName,\r\n    DemographicCountryCode as CountryCode,\r\n    //DemographicRegionCode,\r\n    LandingSearchTerm,\r\n    LandingSearchEngine,\r\n    SessionStartTimestamp,\r\n\r\n    date(StartTimeDate) as StartTimeDate,\r\n    monthname(date(StartTimeDate)) as StartTimeMonthYear,\r\n    year(date(StartTimeDate)) as StartTimeYear,\r\n\r\n\r\n\r\nweekday(StartTimeDate) as StartDayName,\r\n\r\n    StartHour,\r\n    //StartYear,\r\n    //StartMonth,\r\n    StartDay,\r\n    //IpAddress,\r\n    //BrowserName,\r\n    //BrowserVersion,\r\n    //PlatformName,\r\n    //SessionEntryPage,\r\n\r\n\r\n    //LandingReferrer,\r\n\r\nsubfield(LandingReferrer,'/',1)&'//'&subfield(LandingReferrer,'/',3) as LandingReferrer,\r\n    \r\n//PlatformSystemInfo,\r\n\r\n    //PlatformSystemType,\r\n\r\nif (PlatformSystemType = 'Mobile/PDA', 'Mobile','PC') as DeviceType,\r\n\r\n    //BrowserGroup,\r\n    //PlatformGroup,\r\n    //BrowserUserAgent,\r\n    LandingCampaign,\r\n    LandingPlacement,\r\n    LandingCreative,\r\n    LandingCampaignType,\r\n    CookieUniqueVisitorTrackingId,\r\n    CookieFrequency,\r\n    NewCustomer,\r\n    //CookiePreviousVisitTimestamp,\r\n    //if (VisitorUiid = 'Not Given', recno(), VisitorUiid) as VisitorUiid,\r\n   VisitorUiid,\r\n\r\nVisitorUiid as %UserKey,\r\n\r\n\r\n    VisitorLastUpdateTimestamp,\r\n    VisitorUserType,\r\n    VisitorIdentifications\r\n\r\nFROM [lib://QVDStore/StartSession.qvd]\r\n(qvd);\r\n\r\n\r\n\r\nLOAD\r\n    SessionNumber,\r\n    BasketPurchased,\r\n    //Visits,\r\n    //BasketUser,\r\n    //ProductID,\r\n    //ProductActionType,\r\n    //ProductActionTimestamp,\r\n    //ProductSkuNum,\r\n    ProductDisplayName,\r\n    //SkuFlag,\r\n    ProductQuantity,\r\n    ProductBaseValuePerItem,\r\n    ProductValuePerItem,\r\n    ProductCurrencyCode\r\nFROM [lib://QVDStore/Basket.qvd]\r\n(qvd);\r\n\r\n// LOAD\r\n//     SessionNumber,\r\n//     BasketUserA,\r\n//     ProductDisplayNameA,\r\n//     ProductActionTimestampA,\r\n//     ProductVolume,\r\n//     PurchasePath\r\n// FROM [lib://QVDStore/BasketPathTemp.qvd]\r\n// (qvd);\r\n\r\n// LOAD\r\n//     SessionNumber,\r\n//     ErrorDescription,\r\n//     ErrorTimestamp,\r\n//     ErrorTimeStampNum,\r\n//     ErrorFlag,\r\n//     ErrorCount,\r\n//     lapsedhour,\r\n//     lapsedmin,\r\n//     lapsedsecond,\r\n//     lapsederrortime\r\n// FROM [lib://QVDStore/Errors.qvd]\r\n// (qvd);\r\n\r\nLOAD\r\n    SessionNumber,\r\n    BasketProductsViewed,\r\n    BasketProductsAdded,\r\n    AbandonedSession,\r\n    PurchasedSession,\r\n    AbandonandPurchaseSession,\r\n    BasketProductsFailedAdd,\r\n    BasketProductsRemoved,\r\n    BasketProductsPurchased,\r\n    BasketAbandonedValue,\r\n    BasketPurchasedValue,\r\n    SessionMetricValue,\r\n    SessionExitPage,\r\n    SessionCookiesEnabled,\r\n    SessionShortSession,\r\n    SessionSinglePage,\r\n    SessionScriptError,\r\n    SessionMultiPage,\r\n    SessionDuration,\r\n    SessionOffsiteTime,\r\n    SessionIdleTime,\r\n    SessionPages,\r\n    SystemLanguage,\r\n    SystemConnection,\r\n    SessionPopupStatus,\r\n    SessionOptOutStatus,\r\n    UserDataVolume,\r\n    UserDuration,\r\n    NetworkDataVolume,\r\n    NetworkDuration,\r\n    SessionFirstInteraction,\r\n    Attributions\r\n    //deleteme\r\nFROM [lib://QVDStore/Outcomes.qvd]\r\n(qvd);\r\n\r\n// LOAD\r\n//     SessionNumber,\r\n//     PageLoadDuration,\r\n//     PageImagesCompleteDuration,\r\n//     PageBrowserSizeWidth,\r\n//     PageBrowserSizeHeight,\r\n//     PageLoadTimestamp,\r\n//     PageInstanceID,\r\n//     PageSequenceInSession,\r\n//     AttributionSequenceInSession,\r\n//     PageIsDeadEnd,\r\n//     PageAliasName1,\r\n//     PageAliasValue1,\r\n//     PageAliasName2,\r\n//     PageAliasValue2,\r\n//     PageAliasName3,\r\n//     PageAliasValue3,\r\n//     PageAliasName4,\r\n//     PageAliasValue4,\r\n//     PageAliasName5,\r\n//     PageAliasValue5,\r\n//     PageAliasName6,\r\n//     PageAliasValue6,\r\n//     PageAliasName7,\r\n//     PageAliasValue7,\r\n//     PageAliasName8,\r\n//     PageAliasValue8,\r\n//     PageAliasName9,\r\n//     PageAliasValue9,\r\n//     PageAliasName10,\r\n//     PageAliasValue10\r\n// FROM [lib://QVDStore/PagesTable.qvd]\r\n// (qvd);\r\n\r\n// LOAD\r\n//     SessionNumber,\r\n//     PurchasePathVolume,\r\n//     PurchaseChainEngine\r\n// FROM [lib://QVDStore/PurchasePath.qvd]\r\n// (qvd);\r\n\r\n// LOAD\r\n//     SessionNumber,\r\n//     FormName,\r\n//     FormStartTimestamp,\r\n//     FormIsSuccess,\r\n//     \"FieldName\"\r\n// FROM [lib://QVDStore/rptformoutcome.qvd]\r\n// (qvd);\r\n\r\n\r\n// LOAD\r\n//     SessionNumber,\r\n//     GoalName,\r\n//     GoalTimestamp,\r\n//     GoalRevenue\r\n// FROM [lib://QVDStore/rptgoals.qvd]\r\n// (qvd);\r\n\r\n\r\n// LOAD\r\n//     SessionNumber,\r\n//     //InternalSearchName,\r\n//     //InternalSearchTimestamp,\r\n//     InternalSearchField,\r\n//     InternalSearchTerm\r\n// FROM [lib://QVDStore/rptinternalsearch.qvd]\r\n// (qvd);\r\n\r\n// LOAD\r\n//     SessionNumber,\r\n//     PromotionName,\r\n//     PromotionPlacement,\r\n//     PromotionCreative,\r\n//     PromotionType,\r\n//     PromotionTimestamp\r\n// FROM [lib://QVDStore/rptpromotions.qvd]\r\n// (qvd);\r\n\r\n// LOAD\r\n//     SessionNumber,\r\n//     StepEventID,\r\n//     IsLastStep,\r\n//     IsCompleteStep,\r\n//     IsReloadStep\r\n// FROM [lib://QVDStore/rpttransactionstepsummary.qvd]\r\n// (qvd);\r\n\r\n\r\n// LOAD\r\n//     SessionNumber,\r\n//     TransactionMaxStepSeq,\r\n//     TransactionEndTimestamp,\r\n//     TransactionIsComplete\r\n// FROM [lib://QVDStore/rpttransactionsummary.qvd]\r\n// (qvd);\r\n\r\n// LOAD\r\n//     VisitorUiid,\r\n//     SessionDays,\r\n//     PurchaseDays,\r\n//     LastPurchase,\r\n//     LastVisit,\r\n//     BiggestPurchase,\r\n//     LastError,\r\n//     NewCustomerSummaryFlag,\r\n//     VisitSinceError,\r\n//     Visit_AfterError\r\n// FROM [lib://QVDStore/SummaryFinal.qvd]\r\n// (qvd);\r\n\r\n// LOAD\r\n//     VisitorUiidA,\r\n//     NewCustomerA,\r\n//     PurchaseDateA,\r\n//     ErrorDateA,\r\n//     StartDayA,\r\n//     PurchasedValueA\r\n// FROM [lib://QVDStore/SummaryOut.qvd]\r\n// (qvd);\r\n\r\n///$tab CountryCodes\r\nLeft Join (StartSession)\r\n\r\nLOAD\r\n\r\n    Name as Country,\r\n    Code as CountryCode\r\n\r\nFROM [lib://QVDStore/ISO_Codes_Country_2Letter.csv]\r\n(txt, utf8, embedded labels, delimiter is ',', msq);\r\n///$tab User Data\r\nLOAD\r\n    email as %UserKey,\r\n    email,\r\n    gender,\r\n    firstName,\r\n    lastName,\r\n    phoneNumber,\r\n    1 as UserCounter\r\n\r\nFROM [lib://QVDStore/UserData.csv]\r\n(txt, codepage is 1252, embedded labels, delimiter is ',', msq);\r\n///$tab !!!!  EXIT !!!!\r\nExit Script;\r\n///$tab autoCalendar\r\n[autoCalendar]: \r\n\r\nDECLARE FIELD DEFINITION Tagged ('$date')\r\nFIELDS\r\n  Dual(Year($1), YearStart($1)) AS [Year] Tagged ('$axis', '$year'),\r\n  Dual('Q'&Num(Ceil(Num(Month($1))/3)),Num(Ceil(NUM(Month($1))/3),00)) AS [Quarter] Tagged ('$quarter'),\r\n  Dual(Year($1)&'-Q'&Num(Ceil(Num(Month($1))/3)),QuarterStart($1)) AS [YearQuarter] Tagged ('$axis', '$yearquarter'),\r\n  Month($1) AS [Month] Tagged ('$month'),\r\n  Dual(Year($1)&'-'&Month($1), monthstart($1)) AS [YearMonth] Tagged ('$axis', '$yearmonth'),\r\n  Dual('W'&Num(Week($1),00), Num(Week($1),00)) AS [Week] Tagged ('$weeknumber'),\r\n  Date(Floor($1)) AS [Date] Tagged ('$date');\r\n\r\nDERIVE FIELDS FROM FIELDS [SessionStartTimestamp], [CookiePreviousVisitTimestamp], [VisitorLastUpdateTimestamp], [deleteme], [TransactionEndTimestamp] USING [autoCalendar] ;\r\n///$tab Auto-generated section\r\nLIB CONNECT TO [MySQL];\r\n\r\nStartSession:\r\nSQL SELECT \r\n`SessionNumber`,\r\n\t`DemographicOrganisation`,\r\n\t`DemographicIsp`,\r\n\t`DemographicLatitude`,\r\n\t`DemographicLongitude`,\r\n\t`DemographicCityName`,\r\n\t`DemographicCountryCode`,\r\n\t`DemographicRegionCode`,\r\n\t`LandingSearchTerm`,\r\n\t`LandingSearchEngine`,\r\n\t`SessionStartTimestamp`,\r\n    date(floor(SessionStartTimestamp)) as StartTimeDate,\r\n    hour(floor(SessionStartTimestamp)) as StartHour,\r\n    YEAR (SessionStartTimestamp) as StartYear,\r\n    MONTH(floor(SessionStartTimestamp)) as StartMonth,\r\n    DAY(SessionStartTimestamp) as StartDay,\r\n\t`IpAddress`,\r\n\t`BrowserName`,\r\n\t`BrowserVersion`,\r\n\t`PlatformName`,\r\n\t`SessionEntryPage`,\r\n\t`LandingReferrer`,\r\n\t`PlatformSystemInfo`,\r\n\t`PlatformSystemType`,\r\n\t`BrowserGroup`,\r\n\t`PlatformGroup`,\r\n\t`BrowserUserAgent`,\r\n\t`LandingCampaign`,\r\n\t`LandingPlacement`,\r\n\t`LandingCreative`,\r\n\t`LandingCampaignType`,\r\n\t`CookieUniqueVisitorTrackingId`,\r\n\t//`CookieFrequency`,\r\n     if(isnull(CookieFrequency) or CookieFrequency=1,'X',CookieFrequency) as CookieFrequency,\r\n     if(isnull(CookieFrequency) or CookieFrequency=1,'Yes','No') as NewCustomer,\r\n\t`CookiePreviousVisitTimestamp`,\r\n\t//`VisitorUiid`,\r\n    if(ISNULL(VisitorUiid),'Not Given',VisitorUiid) as VisitorUiid,\r\n\t`VisitorLastUpdateTimestamp`,\r\n\t`VisitorUserType`,\r\n\t`VisitorIdentifications`\r\nFROM `shoecare`.`rptsessionstart`;\r\n\r\nOutcomes:\r\nLOAD \r\n\t[SessionNumber] AS [SessionNumber],\r\n\t[BasketProductsViewed] AS [BasketProductsViewed],\r\n\t[BasketProductsAdded] AS [BasketProductsAdded],\r\n      if (BasketAbandonedValue > 0, '1', '0') as AbandonedSession,\r\n    if (BasketPurchasedValue > 0, '1', '0') as PurchasedSession,\r\n    if (BasketAbandonedValue > 0 and BasketPurchasedValue>0, '1', '0') as AbandonandPurchaseSession,\r\n\t[BasketProductsFailedAdd] AS [BasketProductsFailedAdd],\r\n\t[BasketProductsRemoved] AS [BasketProductsRemoved],\r\n\t[BasketProductsPurchased] AS [BasketProductsPurchased],\r\n\t[BasketAbandonedValue] AS [BasketAbandonedValue],\r\n\t[BasketPurchasedValue] AS [BasketPurchasedValue],\r\n\t[SessionMetricValue] AS [SessionMetricValue],\r\n\t[SessionExitPage] AS [SessionExitPage],\r\n\t[SessionCookiesEnabled] AS [SessionCookiesEnabled],\r\n\t[SessionShortSession] AS [SessionShortSession],\r\n\t[SessionSinglePage] AS [SessionSinglePage],\r\n\t[SessionScriptError] AS [SessionScriptError],\r\n\t[SessionMultiPage] AS [SessionMultiPage],\r\n\t[SessionDuration] AS [SessionDuration],\r\n\t[SessionOffsiteTime] AS [SessionOffsiteTime],\r\n\t[SessionIdleTime] AS [SessionIdleTime],\r\n\t[SessionPages] AS [SessionPages],\r\n\t[SystemLanguage] AS [SystemLanguage],\r\n\t[SystemConnection] AS [SystemConnection],\r\n\t[SessionPopupStatus] AS [SessionPopupStatus],\r\n\t[SessionOptOutStatus] AS [SessionOptOutStatus],\r\n\t[UserDataVolume] AS [UserDataVolume],\r\n\t[UserDuration] AS [UserDuration],\r\n\t[NetworkDataVolume] AS [NetworkDataVolume],\r\n\t[NetworkDuration] AS [NetworkDuration],\r\n\t[SessionFirstInteraction] AS [SessionFirstInteraction],\r\n\t[Attributions] AS [Attributions],\r\n\t[SessionStartTimestamp] AS [deleteme];\r\n\r\nSQL SELECT \r\n`SessionNumber`,\r\n\t`BasketProductsViewed`,\r\n\t`BasketProductsAdded`,\r\n\t`BasketProductsFailedAdd`,\r\n\t`BasketProductsRemoved`,\r\n\t`BasketProductsPurchased`,\r\n\t`BasketAbandonedValue`,\r\n\t`BasketPurchasedValue`,\r\n  \r\n\t`SessionMetricValue`,\r\n\t`SessionExitPage`,\r\n\t`SessionCookiesEnabled`,\r\n\t`SessionShortSession`,\r\n\t`SessionSinglePage`,\r\n\t`SessionScriptError`,\r\n\t`SessionMultiPage`,\r\n\t`SessionDuration`,\r\n\t`SessionOffsiteTime`,\r\n\t`SessionIdleTime`,\r\n\t`SessionPages`,\r\n\t`SystemLanguage`,\r\n\t`SystemConnection`,\r\n\t`SessionPopupStatus`,\r\n\t`SessionOptOutStatus`,\r\n\t`UserDataVolume`,\r\n\t`UserDuration`,\r\n\t`NetworkDataVolume`,\r\n\t`NetworkDuration`,\r\n\t`SessionFirstInteraction`,\r\n\t`Attributions`,\r\n\t`SessionStartTimestamp`\r\nFROM `shoecare`.`rptsessionoutcome`;\r\n\r\n[rpttransactionsummary]:\r\nLOAD \r\n\t[SessionNumber] AS [SessionNumber],\r\n\t[TransactionMaxStepSeq] AS [TransactionMaxStepSeq],\r\n\t[TransactionEndTimestamp] AS [TransactionEndTimestamp],\r\n\t[TransactionIsComplete] AS [TransactionIsComplete];\r\n\r\nSQL SELECT \r\n`SessionNumber`,\r\n\t`TransactionMaxStepSeq`,\r\n\t`TransactionEndTimestamp`,\r\n\t`TransactionIsComplete`\r\nFROM `shoecare`.`rpttransactionsummary`;\r\n\r\n[rpttransactionstepsummary]:\r\nLOAD \r\n\t[SessionNumber] AS [SessionNumber],\r\n\t[StepEventID] AS [StepEventID],\r\n\t[IsLastStep] AS [IsLastStep],\r\n\t[IsCompleteStep] AS [IsCompleteStep],\r\n\t[IsReloadStep] AS [IsReloadStep];\r\n\r\nSQL SELECT \r\n`SessionNumber`,\r\n\t`StepEventID`,\r\n\t`IsLastStep`,\r\n\t`IsCompleteStep`,\r\n\t`IsReloadStep`\r\nFROM `shoecare`.`rpttransactionstepsummary`;\r\n\r\nPagesTable:\r\nLOAD SessionNumber,\r\n//     BrowserVersion,\r\n//     PlatformName,\r\n//     SessionEntryPage,\r\n//     LandingReferrer,\r\n//     PlatformSystemInfo,\r\n    PageLoadDuration,\r\n    PageImagesCompleteDuration,\r\n    PageBrowserSizeWidth,\r\n    PageBrowserSizeHeight,\r\n    PageLoadTimestamp,\r\n    PageInstanceID,\r\n    PageSequenceInSession,\r\n    AttributionSequenceInSession,\r\n    PageIsDeadEnd,\r\n    PageAliasName1,\r\n    PageAliasValue1,\r\n    PageAliasName2,\r\n    PageAliasValue2,\r\n    PageAliasName3,\r\n    PageAliasValue3,\r\n    PageAliasName4,\r\n    PageAliasValue4,\r\n    PageAliasName5,\r\n    PageAliasValue5,\r\n    PageAliasName6,\r\n    PageAliasValue6,\r\n    PageAliasName7,\r\n    PageAliasValue7,\r\n    PageAliasName8,\r\n    PageAliasValue8,\r\n    PageAliasName9,\r\n    PageAliasValue9,\r\n    PageAliasName10,\r\n    PageAliasValue10;\r\nSQL SELECT SessionNumber,\r\n//     BrowserVersion,\r\n//     PlatformName,\r\n//     SessionEntryPage,\r\n//     LandingReferrer,\r\n//     PlatformSystemInfo,\r\n    PageLoadDuration,\r\n    PageImagesCompleteDuration,\r\n    PageBrowserSizeWidth,\r\n    PageBrowserSizeHeight,\r\n    PageLoadTimestamp,\r\n    PageInstanceID,\r\n    PageSequenceInSession,\r\n    AttributionSequenceInSession,\r\n    PageIsDeadEnd,\r\n    PageAliasName1,\r\n    PageAliasValue1,\r\n    PageAliasName2,\r\n    PageAliasValue2,\r\n    PageAliasName3,\r\n    PageAliasValue3,\r\n    PageAliasName4,\r\n    PageAliasValue4,\r\n    PageAliasName5,\r\n    PageAliasValue5,\r\n    PageAliasName6,\r\n    PageAliasValue6,\r\n    PageAliasName7,\r\n    PageAliasValue7,\r\n    PageAliasName8,\r\n    PageAliasValue8,\r\n    PageAliasName9,\r\n    PageAliasValue9,\r\n    PageAliasName10,\r\n    PageAliasValue10\r\nFROM shoecare.rptpages;\r\n\r\n\r\n\r\nLOAD SessionNumber,\r\n    GoalName,\r\n    GoalTimestamp,\r\n    GoalRevenue;\r\nSQL SELECT SessionNumber,\r\n    GoalName,\r\n    GoalTimestamp,\r\n    GoalRevenue\r\nFROM shoecare.rptgoals;\r\n\r\n\r\nBasket:\r\nLOAD SessionNumber,\r\n    BasketProductsPurchased as BasketPurchased,\r\n    Visits,\r\n    VisitorUiid as BasketUser,\r\n    ProductID,\r\n  //  ProductDisplayName,\r\n    ProductActionType,\r\n    ProductActionTimestamp,\r\n    ProductSkuNum,\r\n    if (ProductDisplayName='null' or ISNULL(ProductDisplayName), if(ISNULL(ProductSkuNum),'Not Provided', ProductSkuNum),ProductDisplayName) as ProductDisplayName,\r\n    if(ISNULL(ProductSkuNum),1,0) as SkuFlag,\r\n    ProductQuantity,\r\n    ProductBaseValuePerItem,\r\n    ProductValuePerItem,\r\n    ProductCurrencyCode;\r\nSQL SELECT SessionNumber,\r\n    BasketProductsPurchased,\r\n    Visits,\r\n    VisitorUiid,\r\n    ProductID,\r\n    ProductDisplayName,\r\n    ProductActionType,\r\n    ProductActionTimestamp,\r\n    ProductSkuNum,\r\n    ProductQuantity,\r\n    ProductBaseValuePerItem,\r\n    ProductValuePerItem,\r\n    ProductCurrencyCode\r\nFROM shoecare.rptbasketactionsoutcome;\r\n\r\n\r\n\r\nLOAD SessionNumber,\r\n    FormName,\r\n    FormStartTimestamp,\r\n    FormIsSuccess,\r\n    `FieldName`;\r\nSQL SELECT SessionNumber,\r\n    FormName,\r\n    FormStartTimestamp,\r\n    FormIsSuccess,\r\n    `FieldName`\r\nFROM shoecare.rptformoutcome;\r\n\r\nLIB CONNECT TO 'MySQL';\r\n\r\nLOAD SessionNumber,\r\n    InternalSearchName,\r\n    InternalSearchTimestamp,\r\n    InternalSearchField,\r\n    InternalSearchTerm;\r\nSQL SELECT SessionNumber,\r\n    InternalSearchName,\r\n    InternalSearchTimestamp,\r\n    InternalSearchField,\r\n    InternalSearchTerm\r\nFROM shoecare.rptinternalsearch;\r\n\r\nLIB CONNECT TO 'MySQL';\r\nErrorsTemp:\r\nLOAD SessionNumber,\r\n    ErrorDescription,\r\n    if(IsNull(ErrorDescription),0,1) as ErrorFlag,\r\n    floor(ErrorTimestamp) + frac(ErrorTimestamp) as ErrorTimeStampNum,\r\n    ErrorTimestamp,\r\n    ErrorAttributeName1,\r\n    ErrorAttributeValue1,\r\n    ErrorAttributeName2,\r\n    ErrorAttributeValue2;\r\nSQL SELECT SessionNumber,\r\n    ErrorDescription,\r\n    ErrorTimestamp,\r\n    ErrorAttributeName1,\r\n    ErrorAttributeValue1,\r\n    ErrorAttributeName2,\r\n    ErrorAttributeValue2\r\nFROM shoecare.rptpageerrorsoutcome;\r\n\r\nErrorsTemp2:\r\nLOAD *, \r\n\t1 as pointless\r\n//\tif (Peek(SessionNumber)=SessionNumber,Hour(ErrorTimestamp-peek(ErrorTimestamp))&':'&minute(ErrorTimestamp-peek(ErrorTimestamp))&':'&second(ErrorTimestamp-peek(ErrorTimestamp)),0) as lapsederrortime\r\nRESIDENT ErrorsTemp WHERE NOT(ISNULL(ErrorTimestamp)) order by SessionNumber, ErrorTimestamp;\r\n\r\nErrorsTemp3:\r\n// LOAD *,\r\n// \tif (Peek(SessionNumber)=SessionNumber,Hour(ErrorTimestamp-peek(ErrorTimestamp))&':'&minute(ErrorTimestamp-peek(ErrorTimestamp))&':'&second(ErrorTimestamp-peek(ErrorTimestamp)),0) as lapsederrortime;\r\nnoconcatenate LOAD \r\n    MAX(SessionNumber) as SessionNumber,\r\n    MAXSTRING(ErrorDescription) as ErrorDescription,\r\n    MAX(ErrorTimestamp) as ErrorTimestamp,\r\n    MAX(ErrorTimeStampNum) as ErrorTimeStampNum,\r\n    MAX(ErrorFlag) as ErrorFlag,\r\n\tONLY(1) as ErrorCount \r\n    RESIDENT ErrorsTemp2 GROUP BY SessionNumber, ErrorDescription, ErrorTimestamp;\r\n\r\nErrors:\r\n\t\r\n    LOAD *,\r\n    If(LEN(lapsedhour)<2,'0'&lapsedhour,lapsedhour) & ':' & If(LEN(lapsedmin)<2,'0'&lapsedmin,lapsedmin) & ':' & If(LEN(lapsedsecond)<2,'0'&lapsedsecond,lapsedsecond) as lapsederrortime;\r\n    \r\n    LOAD *,\r\n    if (Peek(SessionNumber)=SessionNumber,Hour(ErrorTimestamp-peek(ErrorTimestamp)),0) as lapsedhour,\r\n    if (Peek(SessionNumber)=SessionNumber,Minute(ErrorTimestamp-peek(ErrorTimestamp)),0) as lapsedmin,\r\n    if (Peek(SessionNumber)=SessionNumber,second(ErrorTimestamp-peek(ErrorTimestamp)),0) as lapsedsecond\r\n \t//if (Peek(SessionNumber)=SessionNumber,num(Hour(ErrorTimestamp-peek(ErrorTimestamp)),'00#')&':'&minute(ErrorTimestamp-peek(ErrorTimestamp))&':'&second(ErrorTimestamp-peek(ErrorTimestamp)),0) as lapsederrortime\r\n    RESIDENT ErrorsTemp3;\r\n\r\n\r\nDROP TABLE ErrorsTemp;\r\n\r\nDROP TABLE ErrorsTemp2;\r\n\r\nDROP TABLE ErrorsTemp3;\r\n\r\nLIB CONNECT TO 'MySQL';\r\n\r\nLOAD SessionNumber,\r\n    PromotionName,\r\n    PromotionPlacement,\r\n    PromotionCreative,\r\n    PromotionType,\r\n    PromotionTimestamp;\r\nSQL SELECT SessionNumber,\r\n    PromotionName,\r\n    PromotionPlacement,\r\n    PromotionCreative,\r\n    PromotionType,\r\n    PromotionTimestamp\r\nFROM shoecare.rptpromotions;\r\n\r\n\r\n\r\n\r\n\r\n[autoCalendar]: \r\n  DECLARE FIELD DEFINITION Tagged ('$date')\r\nFIELDS\r\n  Dual(Year($1), YearStart($1)) AS [Year] Tagged ('$axis', '$year'),\r\n  Dual('Q'&Num(Ceil(Num(Month($1))/3)),Num(Ceil(NUM(Month($1))/3),00)) AS [Quarter] Tagged ('$quarter'),\r\n  Dual(Year($1)&'-Q'&Num(Ceil(Num(Month($1))/3)),QuarterStart($1)) AS [YearQuarter] Tagged ('$axis', '$yearquarter'),\r\n  Month($1) AS [Month] Tagged ('$month'),\r\n  Dual(Year($1)&'-'&Month($1), monthstart($1)) AS [YearMonth] Tagged ('$axis', '$yearmonth'),\r\n  Dual('W'&Num(Week($1),00), Num(Week($1),00)) AS [Week] Tagged ('$weeknumber'),\r\n  Date(Floor($1)) AS [Date] Tagged ('$date');\r\n\r\nDERIVE FIELDS FROM FIELDS [SessionStartTimestamp], [CookiePreviousVisitTimestamp], [VisitorLastUpdateTimestamp], [deleteme], [TransactionEndTimestamp] USING [autoCalendar] ;\r\n///$tab Summary User\r\nSummaryTemp:\r\nLOAD SessionNumber as SessionNumberA,\r\n\tVisitorUiid as VisitorUiidA,\r\n    NewCustomer as NewCustomerA,\r\n    floor(SessionStartTimestamp) as StartDayA\r\n    RESIDENT StartSession where NOT (ISNULL(VisitorUiid));\r\n    \r\n left join (SummaryTemp)\r\n \r\n LOAD SessionNumber as SessionNumberA,\r\n PurchasedSession as PurchasedSessionA,\r\n BasketPurchasedValue as PurchasedValueA\r\n Resident Outcomes;\r\n \r\n  left join (SummaryTemp)\r\n \r\n LOAD \r\n \tSessionNumber as SessionNumberA,\r\n \tErrorFlag as ErrorFlagA,\r\n    floor(ErrorTimestamp) as ErrorTimeStampA\r\n    RESIDENT Errors;\r\n \t\t\r\n \r\n SummaryOut:\r\n LOAD \r\n \tVisitorUiidA,\r\n    NewCustomerA,\r\n    if (PurchasedSessionA=1, StartDayA,0) as PurchaseDateA,\r\n    if (ErrorFlagA=1,ErrorTimeStampA,0) as ErrorDateA,\r\n    StartDayA,\r\n    PurchasedValueA\r\n    RESIDENT SummaryTemp;\r\n\r\n\r\n\r\nDrop Table SummaryTemp;\r\n\r\nSummaryNearlyFinal:\r\nLOAD *,\r\n\tIf(LastError=0,'No Error',LastVisit-LastError) as Visit_AfterError;\r\nLoad\r\n\tVisitorUiidA as VisitorUiid,\r\n    COUNT(DISTINCT StartDayA) as SessionDays,\r\n    // Redefined the Purchase Days field to reflect actual purchases\r\n    COUNT(DISTINCT PurchaseDateA)-1 as PurchaseDays,\r\n    date(MAX(PurchaseDateA)) as LastPurchase,\r\n    date(MAX(StartDayA)) as LastVisit,\r\n    MAX(PurchasedValueA) as BiggestPurchase,\r\n    date(MAX(ErrorDateA)) as LastError,\r\n    MINSTRING(NewCustomerA) as NewCustomerSummaryFlag,\r\n    If (MAX(ErrorDateA)=MAX(StartDayA),'No','Yes') as VisitSinceError\r\n    RESIDENT SummaryOut GROUP BY VisitorUiidA;\r\n    \r\nSummaryFinal:\r\nNoConcatenate LOAD * RESIDENT SummaryNearlyFinal WHERE NOT(ISNULL(LastVisit));\r\n\r\nDROP TABLE SummaryNearlyFinal;\r\n\r\nBasketSummary:\r\nLOAD \r\nSessionNumber, \r\nProductDisplayName as ProductDisplayNameA,\r\nProductActionTimestamp as ProductActionTimestampA,\r\nBasketPurchased as BasketPurchasedA,\r\nBasketUser as BasketUserA\r\nResident Basket WHERE NOT(ISNULL(BasketUser)) order by BasketUser,  ProductSkuNum, ProductActionTimestamp, SessionNumber;\r\n \r\n \r\nBasketPathTemp:\r\nLOAD \r\nSessionNumber,\r\nBasketUserA,\r\nProductDisplayNameA,\r\nProductActionTimestampA,\r\nif (BasketPurchasedA=0, 1, BasketPurchasedA) as ProductVolume,\r\nBasketUserA &',' & ProductDisplayNameA & ',' & if(BasketPurchasedA=0,'Abandon', 'Purchase') as PurchasePath\r\nResident BasketSummary;\r\n\r\nDROP TABLE BasketSummary;\r\nLIB CONNECT TO 'MySQL';\r\n\r\n///$tab Purchase Path\r\nstartext:\r\nLOAD SessionNumber, \r\n    LandingSearchTerm as LandingSearchTermx,\r\n    LandingSearchEngine as LandingSearchEnginex,\r\n    NewCustomer as NewCustomerx\r\n    RESIDENT StartSession;\r\n    \r\nleft join (startext)\r\nLOAD SessionNumber,\r\n   BasketProductsViewed as ProductsViewedx,\r\n    BasketProductsAdded as ProductsAddedx,\r\n    BasketProductsFailedAdd as ProductsFailedAddx,\r\n    BasketProductsRemoved as ProductsRemovedx,\r\n    BasketProductsPurchased as ProductsPurchasedx,\r\n    PurchasedSession as PurchasedSessionx,\r\n    AbandonedSession as AbandonSessionx,\r\n    AbandonandPurchaseSession as AbandonandPurchaseSessionx,\r\n    BasketPurchasedValue as PurchasedValuex\r\n    RESIDENT Outcomes;\r\n    \r\n PurchasePath:\r\n LOAD SessionNumber, \r\n \t1 as PurchasePathVolume,\r\n    if(ISNULL(LandingSearchEnginex),'None', LandingSearchEnginex) & ',' & \r\n    if (ProductsViewedx > 0, 'Products Viewed,','No Action,') &\r\n    if (ProductsAddedx >0, 'Products Added,', '') &\r\n    if (ProductsPurchasedx > 0, 'Products Purchased,', '') &\r\n    If (LandingSearchEnginex ='Yes', 'Products Adbandonned,', '') &\r\n    if( PurchasedSessionx= 'No', 'No Purchase',if (PurchasedValuex> 100, 'Purchase £100+',if (PurchasedValuex> 50,'Purchase £50-£100',if(PurchasedValuex=0,'No Purchase','Purchase <£50'))) )\r\n    as PurchaseChainEngine\r\n    \r\n    Resident startext;\r\n    \r\n    drop table startext;\r\n\r\n///$tab QVD Write\r\nstore StartSession into 'lib://QVDStore/StartSession.qvd';\r\nstore Basket into 'lib://QVDStore/Basket.qvd';\r\nstore SummaryFinal into 'lib://QVDStore/SummaryFinal.qvd';\r\nstore Outcomes into 'lib://QVDStore/Outcomes.qvd';\r\nstore rptformoutcome into 'lib://QVDStore/rptformoutcome.qvd';\r\nstore BasketPathTemp into 'lib://QVDStore/BasketPathTemp.qvd';\r\nstore rpttransactionsummary into 'lib://QVDStore/rpttransactionsummary.qvd';\r\nstore rpttransactionstepsummary into 'lib://QVDStore/rpttransactionstepsummary.qvd';\r\nstore rptinternalsearch into 'lib://QVDStore/rptinternalsearch.qvd';\r\nstore PurchasePath into 'lib://QVDStore/PurchasePath.qvd';\r\nstore Errors into 'lib://QVDStore/Errors.qvd';\r\nstore PagesTable into 'lib://QVDStore/PagesTable.qvd';\r\nstore rptpromotions into 'lib://QVDStore/rptpromotions.qvd';\r\nstore rptgoals into 'lib://QVDStore/rptgoals.qvd';\r\nstore SummaryOut into 'lib://QVDStore/SummaryOut.qvd';\r\nstore SummaryOut into 'lib://QVDStore/SummaryOut.qvd';"}}